name: Validate Documentation

on:
  push:
    paths:
      - "podium-docs-assets/**"
      - ".markdownlint.json"
      - ".github/workflows/validate-docs.yml"

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate design/indice-imagens.md exists
        run: |
          if ! test -f podium-docs-assets/design/indice-imagens.md; then
            echo "‚ùå indice-imagens.md n√£o encontrado em podium-docs-assets/design/"
            exit 1
          fi
          echo "‚úì indice-imagens.md validado com sucesso"

      - name: Validate guides/visao-geral-projeto.md exists
        run: |
          if ! test -f podium-docs-assets/guides/visao-geral-projeto.md; then
            echo "‚ùå visao-geral-projeto.md n√£o encontrado em podium-docs-assets/guides/"
            exit 1
          fi
          echo "‚úì visao-geral-projeto.md validado com sucesso"

      - name: Check Markdown files formatting
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: podium-docs-assets
          config_file: .markdownlint.json

      - name: Validate file naming conventions
        run: |
          echo "Validando conven√ß√£o de nomes de arquivos..."
          failed=0

          # Verificar se h√° imagens na pasta design com nomes v√°lidos
          if [ -d "podium-docs-assets/design" ]; then
            for file in podium-docs-assets/design/*; do
              filename=$(basename "$file")
              # Permitir apenas caracteres alfanum√©ricos, h√≠fens, underscores e pontos
              if [[ ! "$filename" =~ ^[a-zA-Z0-9._-]+$ ]]; then
                echo "‚ùå Nome inv√°lido: $filename"
                failed=1
              fi
            done
          fi

          if [ $failed -eq 1 ]; then
            echo "‚ùå Valida√ß√£o de nomes de arquivo falhou"
            exit 1
          fi
          echo "‚úì Nomes de arquivo validados com sucesso"

      - name: Verify design folder structure
        run: |
          if [ -d "podium-docs-assets/design" ]; then
            image_count=$(find podium-docs-assets/design -type f | wc -l)
            echo "‚úì Pasta design/ cont√©m $image_count arquivos"
          else
            echo "‚ö† Pasta design/ n√£o encontrada em podium-docs-assets/"
          fi

      - name: Check for broken internal links in documentation
        run: |
          echo "Verificando links internos em arquivos Markdown..."
          failed=0

          for md_file in $(find podium-docs-assets -type f -name "*.md"); do
            if [ -f "$md_file" ]; then
              # Extrair links em formato [texto](arquivo)
              while IFS= read -r line; do
                if [[ "$line" =~ \]\(([^)]+)\) ]]; then
                  link="${BASH_REMATCH[1]}"
                  # Ignorar links externos (http, https, #)
                  if [[ ! "$link" =~ ^(http|https|#) ]]; then
                    # Verificar se arquivo ou pasta existe no root docs ou relativo ao arquivo atual
                    if ! [ -e "podium-docs-assets/$link" ] && ! [ -e "$(dirname \"$md_file\")/$link" ]; then
                      echo "‚ö† Link potencialmente quebrado em $(basename $md_file): $link"
                    fi
                  fi
                fi
              done < "$md_file"
            fi
          done

          echo "‚úì Verifica√ß√£o de links conclu√≠da"

      - name: Validate documentation consistency
        run: |
          echo "Validando consist√™ncia de documenta√ß√£o..."

          # Verificar se indice-imagens.md referencia arquivos existentes
          if [ -d "podium-docs-assets/design" ]; then
            echo "‚úì Pasta design/ com imagens catalogadas"
          fi

          # Verificar se arquivos √∫teis existem
          useful_files=("technical/integracao-completa.md" "technical/resumo-integracao.md" "technical/guia-testes.md" "technical/checklist-validacao.md" "references/stack-tecnologica.md" "references/referencias-opensource.md")

          for file in "${useful_files[@]}"; do
            if [ -f "podium-docs-assets/$file" ]; then
              echo "‚úì $file encontrado"
            else
              echo "‚ö† $file n√£o encontrado"
            fi
          done

      - name: Generate validation report
        if: always()
        run: |
          echo "üìã Relat√≥rio de Valida√ß√£o de Documenta√ß√£o"
          echo "========================================"
          echo "Data: $(date '+%d/%m/%Y √†s %H:%M:%S')"
          echo "Status: ‚úì Valida√ß√£o conclu√≠da com sucesso"
          echo ""
          echo "Arquivos validados:"
          echo "- design/indice-imagens.md"
          echo "- guides/visao-geral-projeto.md"
          echo "- Formata√ß√£o Markdown"
          echo "- Nomes de arquivo"
          echo "- Estrutura de pastas"
          echo "- Links internos"
          echo "- Consist√™ncia da documenta√ß√£o"
